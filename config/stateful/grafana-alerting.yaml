apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-alerting
  namespace: default
data:
  alerting.yaml: |
    apiVersion: 1
    groups:
    - orgId: 1
      name: Service Health
      folder: Provisioned
      interval: 1m
      rules:
      - uid: service-down
        title: Service Down
        condition: C
        data:
        - refId: A
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: prometheus
          model:
            expr: up
            instant: true
            refId: A
        - refId: B
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: threshold
            expression: B
            conditions:
            - evaluator:
                type: lt
                params:
                - 1
              operator:
                type: and
              reducer:
                type: last
            refId: C
        for: 5m
        noDataState: Alerting
        execErrState: Alerting
        labels:
          severity: critical
        annotations:
          summary: '{{ $labels.job }} is down'
          description: '{{ $labels.job }} ({{ $labels.instance }}) has been down for more than 5 minutes.'
      - uid: pod-crash-looping
        title: Pod Crash Looping
        condition: C
        data:
        - refId: A
          relativeTimeRange:
            from: 900
            to: 0
          datasourceUid: prometheus
          model:
            expr: changes(up[15m]) > 2
            instant: true
            refId: A
        - refId: B
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: threshold
            expression: B
            conditions:
            - evaluator:
                type: gt
                params:
                - 0
              operator:
                type: and
              reducer:
                type: last
            refId: C
        for: 5m
        noDataState: OK
        execErrState: Alerting
        labels:
          severity: critical
        annotations:
          summary: '{{ $labels.job }} is crash looping'
          description: '{{ $labels.job }} ({{ $labels.instance }}) has restarted multiple times in the last 15 minutes.'
      - uid: cert-expiring-soon
        title: Certificate Expiring Soon
        condition: C
        data:
        - refId: A
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: prometheus
          model:
            expr: (certmanager_certificate_expiration_timestamp_seconds - time()) / 86400
            instant: true
            refId: A
        - refId: B
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: threshold
            expression: B
            conditions:
            - evaluator:
                type: lt
                params:
                - 7
              operator:
                type: and
              reducer:
                type: last
            refId: C
        for: 1h
        noDataState: OK
        execErrState: Alerting
        labels:
          severity: critical
        annotations:
          summary: 'Certificate {{ $labels.name }} expiring soon'
          description: '{{ $labels.name }} in namespace {{ $labels.namespace }} expires in {{ $value }} days.'
      - uid: unexpected-hubs
        title: Unexpected Hub Connections
        condition: C
        data:
        - refId: A
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: prometheus
          model:
            expr: bridge_sessions_hub_total
            instant: true
            refId: A
        - refId: B
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: threshold
            expression: B
            conditions:
            - evaluator:
                type: gt
                params:
                - 4
              operator:
                type: and
              reducer:
                type: last
            refId: C
        for: 5m
        noDataState: OK
        execErrState: Alerting
        labels:
          severity: critical
        annotations:
          summary: 'Unexpected hub connections detected'
          description: '{{ $value }} hubs connected (expected 4 or fewer). Possible unauthorized hub connection.'
      - uid: password-changed
        title: Password Changed
        condition: C
        data:
        - refId: A
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: prometheus
          model:
            expr: increase(messages_platform_recv_type_person_passwordchanged[5m])
            instant: true
            refId: A
        - refId: B
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: threshold
            expression: B
            conditions:
            - evaluator:
                type: gt
                params:
                - 0
              operator:
                type: and
              reducer:
                type: last
            refId: C
        for: 0s
        noDataState: OK
        execErrState: Alerting
        labels:
          severity: critical
        annotations:
          summary: 'Password changed'
          description: 'A password change was detected on the platform.'
      - uid: unauthorized-access
        title: Unauthorized Access Attempt
        condition: C
        data:
        - refId: A
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: prometheus
          model:
            expr: >-
              increase(bridge_authz_unauthorized_noplace[5m])
              + increase(bridge_authz_unauthorized_notowner[5m])
              + increase(bridge_authz_unauthorized_wrongperson[5m])
              + increase(bridge_authz_unauthorized_wrongplace[5m])
              + increase(bridge_authz_unauthorized_supportrequest[5m])
            instant: true
            refId: A
        - refId: B
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: threshold
            expression: B
            conditions:
            - evaluator:
                type: gt
                params:
                - 0
              operator:
                type: and
              reducer:
                type: last
            refId: C
        for: 0s
        noDataState: OK
        execErrState: Alerting
        labels:
          severity: critical
        annotations:
          summary: 'Unauthorized access attempt detected'
          description: 'Bridge received unauthorized access attempts in the last 5 minutes.'
      - uid: notification-email-errors
        title: Email Notification Errors
        condition: C
        data:
        - refId: A
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: prometheus
          model:
            expr: increase(notifications_email_error_count[5m])
            instant: true
            refId: A
        - refId: B
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: threshold
            expression: B
            conditions:
            - evaluator:
                type: gt
                params:
                - 0
              operator:
                type: and
              reducer:
                type: last
            refId: C
        for: 5m
        noDataState: OK
        execErrState: Alerting
        labels:
          severity: critical
        annotations:
          summary: 'Email notification errors'
          description: 'Email notifications are failing to send.'
      - uid: scheduler-errors
        title: Scheduler Errors
        condition: C
        data:
        - refId: A
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: prometheus
          model:
            expr: increase(scheduler_command_error[5m])
            instant: true
            refId: A
        - refId: B
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: reduce
            expression: A
            reducer: last
            refId: B
        - refId: C
          relativeTimeRange:
            from: 0
            to: 0
          datasourceUid: "-100"
          model:
            type: threshold
            expression: B
            conditions:
            - evaluator:
                type: gt
                params:
                - 0
              operator:
                type: and
              reducer:
                type: last
            refId: C
        for: 5m
        noDataState: OK
        execErrState: Alerting
        labels:
          severity: critical
        annotations:
          summary: 'Scheduler command errors'
          description: 'Scheduler service is experiencing command errors.'
