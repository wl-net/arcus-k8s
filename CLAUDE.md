# CLAUDE.md

## Project Overview

`arcus-k8s` is a Kubernetes deployment infrastructure project for [Arcus Smart Home](https://github.com/arcus-smart-home), an open-source home automation platform. It provides shell scripts and Kustomize manifests to deploy Arcus on local (k3s) or cloud Kubernetes clusters.

## Repository Layout

```
arcuscmd.sh                  # Main CLI — entry point for all operations
script/
  funcs.sh                   # Core deployment functions
  common.sh                  # Shared utilities (retry, prompts)
config/
  kustomization.yaml         # Root Kustomize manifest (image tags live here)
  configmaps/arcus-config.yml  # Global app config (domains, Cassandra, Kafka)
  deployments/               # One YAML per microservice
  service/                   # Service and Ingress definitions
  stateful/                  # Prometheus & Grafana StatefulSets
  certprovider/              # Let's Encrypt issuers
  jobs/                      # One-shot Kubernetes jobs
  istio/                     # Egress rules (Twilio, Sendgrid, SmartyStreets, APNS)
  templates/                 # Templates applied at runtime (MetalLB address pool)
overlays/
  local-production/          # Base overlay for single-node dev deployments
  local-production-cluster/  # Cluster-specific overrides
.github/workflows/ci.yml    # GitHub Actions CI (shellcheck + kustomize validation)
```

Secrets are written to `secret/` and local overlay state to `overlays/<overlay>-local/` — both are git-ignored.

## Key Technologies

| Layer | Tool / Version |
|---|---|
| Kubernetes distro | k3s v1.32.4 (recommended) |
| Config management | Kustomize |
| Service mesh | Istio v1.26.0 (installed via Helm) |
| Ingress | nginx-ingress v1.14.3 |
| Load balancer | MetalLB v0.15.3 (opt-in) |
| Certificates | cert-manager v1.19.2 + Let's Encrypt |
| Database | Apache Cassandra |
| Messaging | Apache Kafka + Zookeeper |
| Monitoring | Prometheus + Grafana (optional) |

## Common Commands

```bash
# Setup
./arcuscmd.sh setup          # Full first-time cluster init (interactive)
./arcuscmd.sh k3s            # Install or upgrade k3s
./arcuscmd.sh install        # Install/upgrade all infrastructure components
./arcuscmd.sh install nginx  # Install/upgrade a single component (metallb, nginx, cert-manager, istio)
./arcuscmd.sh configure      # Interactive configuration wizard
./arcuscmd.sh shell-setup    # Add 'arcuscmd' shortcut to your shell

# Deploy
./arcuscmd.sh apply          # Deploy/update Arcus configuration
./arcuscmd.sh deploy         # Rolling restart of all services, one at a time
./arcuscmd.sh update         # Pull latest changes, show what changed
./arcuscmd.sh rollback       # Revert to a previous version
./arcuscmd.sh history        # Show recent update history with apply status
./arcuscmd.sh useprodcert    # Switch from staging to production Let's Encrypt cert
./arcuscmd.sh updatehubkeystore  # Convert PKCS#1 key to PKCS#8 for hub-bridge

# Status
./arcuscmd.sh status         # Show services, certificates, and infrastructure versions
./arcuscmd.sh versions       # Show installed vs configured infrastructure versions
./arcuscmd.sh info           # Show DNS to IP/port mappings
./arcuscmd.sh check          # Test public connectivity to Arcus services
./arcuscmd.sh verifyconfig   # Verify all configuration and secrets are present

# Operations
./arcuscmd.sh backupdb       # Backup Cassandra database
./arcuscmd.sh backupconfig   # Backup local configuration (.config, secrets, overlays) to a tarball
./arcuscmd.sh logs <app>     # Get logs for a service (targets running pods only)
./arcuscmd.sh shell <app>    # Get an interactive shell on a pod
./arcuscmd.sh dbshell        # Open Cassandra CQL shell
./arcuscmd.sh modelmanager   # Run model manager jobs (provision database schemas)
./arcuscmd.sh deletepod <app>  # Delete pods matching an application
./arcuscmd.sh help           # List all commands
```

## Making Changes

### Kubernetes manifests
- Edit files under `config/` for changes that apply to all environments.
- Put environment-specific overrides in `overlays/local-production/` (committed) or the `-local` copy (generated by `apply`, not committed).
- Run `./arcuscmd.sh apply` to deploy. The overlay tunable files (`arcus-config-tunable.yml`, `cluster-config-tunable.yml`) are preserved across apply runs.

### Image versions
- Image tags are centrally managed in `config/kustomization.yaml`.

### Secrets
- Secrets are generated once by `configure` and stored in `secret/`. Re-running configure will not overwrite existing secrets.
- Secrets are pushed to the cluster by `apply` (not `configure`).
- Never commit the `secret/` directory.
- Run `./arcuscmd.sh verifyconfig` to check all required secrets are present.

### Adding a new microservice
1. Add a deployment manifest in `config/deployments/`.
2. Add a service manifest in `config/service/` if network access is needed.
3. Reference both in `config/kustomization.yaml` under `resources`.
4. Add any required config keys to `config/configmaps/arcus-config.yml`.
5. Add readiness and liveness probes (TCP socket on the metrics port).

## Infrastructure Notes

- The project targets **k3s** as the recommended Kubernetes distribution.
- MetalLB is opt-in (enable via `./arcuscmd.sh configure` or write `yes` to `.config/metallb`). When enabled, it provides LoadBalancer IPs using the address pool template in `config/templates/metallb.yml`. Configure the subnet to a static range excluded from your DHCP scope.
- Istio is installed via Helm charts, pinned to `$ISTIO_VERSION`. Egress rules in `config/istio/` control outbound traffic to external APIs (Twilio, Sendgrid, SmartyStreets, APNS).
- cert-manager handles Let's Encrypt certificates. Start with the staging issuer and switch to production via `./arcuscmd.sh useprodcert` once DNS is verified.
- Hub-bridge requires PKCS#8 keys; run `./arcuscmd.sh updatehubkeystore` after obtaining a production certificate.

## Per-Node Configuration (`.config/`)

Each node stores its local configuration in `.config/` (git-ignored). These files are read by `load()` at startup and written by `./arcuscmd.sh configure`.

| File | Required | Description |
|---|---|---|
| `domain.name` | Yes | Main Arcus domain (e.g. `arcus.example.com`) |
| `admin.email` | Yes | Let's Encrypt admin email |
| `cert-issuer` | Yes | `staging` or `production` |
| `overlay-name` | Yes | Kustomize overlay to use (e.g. `local-production-cluster`) |
| `metallb` | Optional | `yes` or `no` — enable MetalLB for load balancer IPs |
| `subnet` | If MetalLB | MetalLB IP range (e.g. `192.168.1.200-192.168.1.207`) |
| `proxy-real-ip` | Optional | Upstream proxy IP/subnet for PROXY protocol (e.g. `192.168.1.1/32`) |
| `cassandra-host` | Optional | External Cassandra contact points (omit to use in-cluster) |
| `zookeeper-host` | Optional | External Zookeeper host (omit to use in-cluster) |
| `kafka-host` | Optional | External Kafka host (omit to use in-cluster) |
| `admin-domain` | Optional | Grafana admin domain (e.g. `admin.arcus-dc1.example.com`) |
| `cert-solver` | Optional | `http` (default) or `dns` — use DNS-01 challenges via Route 53 |
| `route53-hosted-zone-id` | If DNS solver | Route 53 hosted zone ID |
| `route53-region` | If DNS solver | AWS region for Route 53 (e.g. `us-east-1`) |

Run `./arcuscmd.sh configure` to set these interactively, or write the files directly.

## Cassandra / Kafka / Zookeeper

The `local-production` overlay includes manifests to run Cassandra, Kafka, and Zookeeper inside k3s with `CASSANDRA_SINGLE_NODE=true`, which is fine for development. For production, these should run externally on a dedicated 3-datacenter Cassandra cluster — a single k3s node provides no real redundancy. The `local-production-cluster` overlay sets `CASSANDRA_SINGLE_NODE=false`. Configure external hosts via `./arcuscmd.sh configure` or by setting `.config/cassandra-host`, `.config/kafka-host`, and `.config/zookeeper-host` directly.

## External Service Dependencies

Arcus requires accounts with:
- **SmartyStreets** — address verification (required for account creation)
- **Twilio** — SMS/voice notifications
- **Sendgrid / Mailgun** — email notifications
- **APNS / GCM** — push notifications (optional, disabled by default)

## Backups

### Configuration
```bash
./arcuscmd.sh backupconfig   # Creates a timestamped tarball of .config, secrets, and local overlays
```

### Database
Cassandra is the only stateful component that needs backup:
```bash
./arcuscmd.sh backupdb               # Snapshot-based backup
./arcuscmd.sh restoredb <file>       # Restore from snapshot backup
./arcuscmd.sh restoredb-full <file>  # Full restore (destructive, replaces data dir)
```

## CI

GitHub Actions runs on push and PRs to master:
- **shellcheck** — lints `arcuscmd.sh`, `script/common.sh`, and `script/funcs.sh`
- **kustomize** — validates `config/` base manifests build cleanly

## Hardware Requirements

- 12 GB RAM minimum
- 20 GB disk minimum
- Public IP with ports 80/443 reachable for Let's Encrypt and mobile app support
